version: "3.9"

services:
    prometheus:
        image: prom/prometheus:v2.55.0
        container_name: prometheus
        restart: unless-stopped
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=15d"
            - "--web.enable-lifecycle"
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus_data:/prometheus
        networks:
            - monitoring
        ports:
            - "${PROMETHEUS_PORT:-9090}:9090"
        security_opt:
            - no-new-privileges:true
        read_only: true
        tmpfs:
            - /tmp
            - /run

    grafana:
        image: grafana/grafana:11.1.0
        container_name: grafana
        restart: unless-stopped
        depends_on:
            - prometheus
        environment:
            GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
            GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
            GF_USERS_ALLOW_SIGN_UP: "false"
            GF_AUTH_ANONYMOUS_ENABLED: "false"
            GF_INSTALL_PLUGINS: "grafana-clock-panel"
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning:ro
        networks:
            - monitoring
        ports:
            - "${GRAFANA_PORT:-3000}:3000"
        user: "472"
        security_opt:
            - no-new-privileges:true
        read_only: true
        tmpfs:
            - /tmp
            - /run

    node-exporter:
        image: prom/node-exporter:v1.8.2
        container_name: node-exporter
        restart: unless-stopped
        command:
            - "--path.rootfs=/host"
        pid: "host"
        volumes:
            - "/:/host:ro,rslave"
        networks:
            - monitoring
        expose:
            - "9100"
        security_opt:
            - no-new-privileges:true
        read_only: true
        tmpfs:
            - /tmp
            - /run

    wordpress-db:
        image: mariadb:11.4
        container_name: wordpress-db
        restart: unless-stopped
        environment:
            MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
            MARIADB_DATABASE: ${WORDPRESS_DB_NAME}
            MARIADB_USER: ${WORDPRESS_DB_USER}
            MARIADB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
        volumes:
            - wordpress_db_data:/var/lib/mysql
        networks:
            - monitoring
        security_opt:
            - no-new-privileges:true

    wordpress:
        image: wordpress:6.6.2-php8.2-apache
        container_name: wordpress
        restart: unless-stopped
        environment:
            WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
            WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
            WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
            WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX}
        volumes:
            - wordpress_data:/var/www/html
        networks:
            - monitoring
        ports:
            - "${WORDPRESS_PORT:-8080}:80"
        security_opt:
            - no-new-privileges:true

networks:
    monitoring:
        driver: bridge

volumes:
    prometheus_data:
    grafana_data:
    wordpress_db_data:
    wordpress_data:
